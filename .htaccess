# 维修管理系统 .htaccess 配置
Header unset X-Powered-By
Header always unset X-Powered-By
# 启用URL重写
RewriteEngine On

# 保护安装文件（安装完成后）
# 如果存在installed.lock文件，则阻止访问install.php
RewriteCond %{REQUEST_FILENAME} -f
RewriteCond %{REQUEST_URI} install\.php$
RewriteCond %{DOCUMENT_ROOT}/config/installed.lock -f
RewriteRule ^(.*)$ index.php [L,R=301]

# 处理API请求
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/(.*)$ api/$1 [L]

# 设置默认字符集
AddDefaultCharset UTF-8

# 安全头设置
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' https://cdn.jsdelivr.net; connect-src 'self'"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
</IfModule>

# 禁止访问敏感文件
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# 禁止访问配置文件
<Files "config.php">
    Order Allow,Deny
    Deny from all
</Files>

# 禁止访问数据库文件
<Files "*.sql">
    Order Allow,Deny
    Deny from all
</Files>

# 设置缓存控制
<IfModule mod_headers.c>
    # 静态资源缓存1个月
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|icon|pdf|swf)$">
        Header set Cache-Control "public, max-age=2592000"
    </FilesMatch>
</IfModule>

# 压缩文件
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>
